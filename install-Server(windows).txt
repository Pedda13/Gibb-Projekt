# Install OpenSSH server if it's not already installed
if (-not (Get-WindowsCapability -Online | Where-Object {$_.Name -like 'OpenSSH.Server*'} -ErrorAction SilentlyContinue)) {
    Add-WindowsCapability -Online -Name OpenSSH.Server~~~~0.0.1.0
}

# Set configuration options for sshd_config file
$configFile = 'C:\ProgramData\ssh\sshd_config'
$configOptions = @{
    'Port' = '22'
    'AddressFamily' = 'any'
    'ListenAddress' = '0.0.0.0, ::'
    'PermitRootLogin' = 'yes'
    'MaxAuthTries' = '6'
    'PubkeyAuthentication' = 'yes'
    'AuthorizedKeysFile' = '.ssh/authorized_keys'
    'PasswordAuthentication' = 'yes'
    'KbdInteractiveAuthentication' = 'no'
    'UsePAM' = 'yes'
    'X11Forwarding' = 'yes'
}

# Update configuration options in sshd_config file
foreach ($key in $configOptions.Keys) {
    $value = $configOptions[$key]
    (Get-Content $configFile) | ForEach-Object {
        if ($_ -match "^$key ") { # find line starting with key
            $_ = "$key $value" # replace value
        }
        $_ # pass line through
    } | Set-Content $configFile
}

# Restart the sshd service to apply configuration changes
Restart-Service sshd
